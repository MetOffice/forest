/*!
* MarchingSquaresJS
* version 1.3.3
* https://github.com/RaumZeit/MarchingSquares.js
*
* @license GNU Affero General Public License.
* Copyright (c) 2015-2019 Ronny Lorenz <ronny@tbi.univie.ac.at>
*/
!function(e,o){"object"==typeof exports&&"undefined"!=typeof module?o(exports):"function"==typeof define&&define.amd?define(["exports"],o):o(e.MarchingSquaresJS=e.MarchingSquaresJS||{})}(this,function(e){"use strict";function g(e,o,t){return e<o?(t-e)/(o-e):(e-t)/(e-o)}function f(){this.successCallback=null,this.verbose=!1,this.polygons=!1,this.polygons_full=!1,this.linearRing=!0,this.noQuadTree=!1,this.noFrame=!1}function y(e,o,t,n){var r=[];return e.polygons.forEach(function(e){e.forEach(function(e){e[0]+=o,e[1]+=t}),n.linearRing&&e.push(e[0]),r.push(e)}),r}function a(e,o,t,n,r){var l=n,s=r,i=0,h=0;if(this.x=o,this.y=t,this.lowerBound=null,this.upperBound=null,this.childA=null,this.childB=null,this.childC=null,this.childD=null,1===n&&1===r)this.lowerBound=Math.min(e[t][o],e[t][o+1],e[t+1][o+1],e[t+1][o]),this.upperBound=Math.max(e[t][o],e[t][o+1],e[t+1][o+1],e[t+1][o]);else{if(1<n){for(;0!==l;)l>>=1,i++;n===1<<i-1&&i--,l=1<<i-1}if(1<r){for(;0!==s;)s>>=1,h++;r===1<<h-1&&h--,s=1<<h-1}this.childA=new a(e,o,t,l,s),this.lowerBound=this.childA.lowerBound,this.upperBound=this.childA.upperBound,0<n-l&&(this.childB=new a(e,o+l,t,n-l,s),this.lowerBound=Math.min(this.lowerBound,this.childB.lowerBound),this.upperBound=Math.max(this.upperBound,this.childB.upperBound),0<r-s&&(this.childC=new a(e,o+l,t+s,n-l,r-s),this.lowerBound=Math.min(this.lowerBound,this.childC.lowerBound),this.upperBound=Math.max(this.upperBound,this.childC.upperBound))),0<r-s&&(this.childD=new a(e,o,t+s,l,r-s),this.lowerBound=Math.min(this.lowerBound,this.childD.lowerBound),this.upperBound=Math.max(this.upperBound,this.childD.upperBound))}}function w(e){var o,t;if(!e)throw new Error("data is required");if(!Array.isArray(e)||!Array.isArray(e[0]))throw new Error("data must be scalar field, i.e. array of arrays");if(e.length<2)throw new Error("data must contain at least two rows");if((t=e[0].length)<2)throw new Error("data must contain at least two columns");for(o=1;o<e.length;o++){if(!Array.isArray(e[o]))throw new Error("Row "+o+" is not an array");if(e[o].length!=t)throw new Error("unequal row lengths detected, please provide a regular grid")}this.data=e,this.root=new a(e,0,0,e[0].length-1,e.length-1)}function o(e,o,t){var n,r,l,s=!1,i=!1,h=null,a=null,p=null,u=null,d=null,c=[];if(!e)throw new Error("data is required");if(null==o)throw new Error("threshold is required");if(t&&"object"!=typeof t)throw new Error("options must be an object");if(n=function(e){var o,t,n,r,l;for(r=new f,e=e||{},l=Object.keys(r),o=0;o<l.length;o++)null!=(n=e[t=l[o]])&&(r[t]=n);return r.polygons_full=!r.polygons,r.interpolate=g,r}(t),e instanceof w)a=(h=e).root,p=e.data,n.noQuadTree||(s=!0);else{if(!Array.isArray(e)||!Array.isArray(e[0]))throw new Error("input is neither array of arrays nor object retrieved from 'QuadTree()'");p=e}if(Array.isArray(o)){for(i=!0,n.noQuadTree||(s=!0),r=0;r<o.length;r++)if(isNaN(+o[r]))throw new Error("threshold["+r+"] is not a number")}else{if(isNaN(+o))throw new Error("threshold must be a number or array of numbers");o=[o]}return s&&!a&&(h=new w(p),a=h.root,p=h.data),n.verbose&&(n.polygons?console.log("MarchingSquaresJS-isoLines: returning single lines (polygons) for each grid cell"):console.log("MarchingSquaresJS-isoLines: returning line paths (polygons) for entire data grid"),i&&console.log("MarchingSquaresJS-isoLines: multiple lines requested, returning array of line paths instead of lines for a single threshold")),o.forEach(function(e,o){if(d=[],n.threshold=e,n.verbose&&console.log("MarchingSquaresJS-isoLines: computing iso lines for threshold "+e),n.polygons)if(s)a.cellsBelowThreshold(n.threshold,!0).forEach(function(e){d=d.concat(y(m(p,e.x,e.y,n),e.x,e.y,n))});else for(l=0;l<p.length-1;++l)for(o=0;o<p[0].length-1;++o)d=d.concat(y(m(p,o,l,n),o,l,n));else{for(u=[],o=0;o<p[0].length-1;++o)u[o]=[];if(s)a.cellsBelowThreshold(n.threshold,!1).forEach(function(e){u[e.x][e.y]=m(p,e.x,e.y,n)});else for(o=0;o<p[0].length-1;++o)for(l=0;l<p.length-1;++l)u[o][l]=m(p,o,l,n);d=function(e,p,u){var d,c,g,f,y,w,m,b,B,v,x,k,A,E,_,M=[],C=e.length-1,N=e[0].length-1,S=["right","bottom","left","top"],T=[0,-1,0,1],q=[-1,0,1,0],D={bottom:1,left:2,top:3,right:0};return u.noFrame||!function(e,o){var t,n,r,l,s;for(t=!0,n=e[0].length,r=e.length,s=0;s<r;s++)if(e[s][0]>=o||e[s][n-1]>=o){t=!1;break}if(t&&(e[r-1][0]>=o||e[r-1][n-1]>=o)&&(t=!1),t)for(l=0;l<n-1;l++)if(e[0][l]>=o||e[r-1][l]>o){t=!1;break}return t}(e,u.threshold)||(u.linearRing?M.push([[0,0],[0,C],[N,C],[N,0],[0,0]]):M.push([[0,0],[0,C],[N,C],[N,0]])),p.forEach(function(e,a){e.forEach(function(e,o){for(d=null,c=0;c<4;c++)if(d=S[c],"object"==typeof e.edges[d]){for(y=[],g=e.edges[d],w=d,b=o,B=!1,v=[(m=a)+g.path[0][0],o+g.path[0][1]],y.push(v);!B&&"object"==typeof(f=p[m][b]).edges[w];)if(g=f.edges[w],delete f.edges[w],(x=g.path[1])[0]+=m,x[1]+=b,y.push(x),w=g.move.enter,m+=g.move.x,b+=g.move.y,void 0===p[m]||void 0===p[m][b]){if(!u.linearRing)break;if(A=k=0,m===N?(m--,k=0):m<0?(m++,k=2):b===C?(b--,k=3):b<0&&(b++,k=1),m===a&&b===o&&k===D[d]){B=!0,w=d;break}for(;;){if(E=!1,4<A)throw new Error("Direction change counter overflow! This should never happen!");if(void 0!==p[m]&&void 0!==p[m][b]&&(f=p[m][b],_=S[k],"object"==typeof f.edges[_])){g=f.edges[_],y.push((l=m,s=b,i=k,h=g.path,0===i?(l+=1,s+=h[0][1]):1===i?l+=h[0][0]:2===i?s+=h[0][1]:3===i&&(l+=h[0][0],s+=1),[l,s])),w=_,E=!0;break}if(E)break;if(y.push((t=m,n=b,0===(r=k)?t++:1===r||(2===r?n++:3===r&&(t++,n++)),[t,n])),b+=q[k],void 0!==p[m+=T[k]]&&void 0!==p[m][b]||(0===k&&b<0||1===k&&m<0||2===k&&b===C||3===k&&m===N)&&(m-=T[k],b-=q[k],k=(k+1)%4,A++),m===a&&b===o&&k===D[d]){B=!0,w=d;break}}}!u.linearRing||y[y.length-1][0]===v[0]&&y[y.length-1][1]===v[1]||y.push(v),M.push(y)}var t,n,r,l,s,i,h})}),M}(p,u,n)}i?c.push(d):c=d,"function"==typeof n.successCallback&&n.successCallback(c,e)}),c}function m(e,o,t,n){var r,l,s,i,h,a,p=0,u=e[t+1][o],d=e[t+1][o+1],c=e[t][o+1],g=e[t][o],f=n.threshold;if(!(isNaN(g)||isNaN(c)||isNaN(d)||isNaN(u))){switch(p|=f<=u?8:0,p|=f<=d?4:0,p|=f<=c?2:0,a={cval:p=+(p|=f<=g?1:0),polygons:[],edges:{},x0:g,x1:c,x2:d,x3:u},p){case 0:n.polygons&&a.polygons.push([[0,0],[0,1],[1,1],[1,0]]);break;case 15:break;case 14:r=n.interpolate(g,u,f),i=n.interpolate(g,c,f),n.polygons_full&&(a.edges.left={path:[[0,r],[i,0]],move:{x:0,y:-1,enter:"top"}}),n.polygons&&a.polygons.push([[0,0],[0,r],[i,0]]);break;case 13:i=n.interpolate(g,c,f),l=n.interpolate(c,d,f),n.polygons_full&&(a.edges.bottom={path:[[i,0],[1,l]],move:{x:1,y:0,enter:"left"}}),n.polygons&&a.polygons.push([[i,0],[1,l],[1,0]]);break;case 11:l=n.interpolate(c,d,f),s=n.interpolate(u,d,f),n.polygons_full&&(a.edges.right={path:[[1,l],[s,1]],move:{x:0,y:1,enter:"bottom"}}),n.polygons&&a.polygons.push([[1,l],[s,1],[1,1]]);break;case 7:r=n.interpolate(g,u,f),s=n.interpolate(u,d,f),n.polygons_full&&(a.edges.top={path:[[s,1],[0,r]],move:{x:-1,y:0,enter:"right"}}),n.polygons&&a.polygons.push([[s,1],[0,r],[0,1]]);break;case 1:r=n.interpolate(g,u,f),i=n.interpolate(g,c,f),n.polygons_full&&(a.edges.bottom={path:[[i,0],[0,r]],move:{x:-1,y:0,enter:"right"}}),n.polygons&&a.polygons.push([[i,0],[0,r],[0,1],[1,1],[1,0]]);break;case 2:i=n.interpolate(g,c,f),l=n.interpolate(c,d,f),n.polygons_full&&(a.edges.right={path:[[1,l],[i,0]],move:{x:0,y:-1,enter:"top"}}),n.polygons&&a.polygons.push([[0,0],[0,1],[1,1],[1,l],[i,0]]);break;case 4:l=n.interpolate(c,d,f),s=n.interpolate(u,d,f),n.polygons_full&&(a.edges.top={path:[[s,1],[1,l]],move:{x:1,y:0,enter:"left"}}),n.polygons&&a.polygons.push([[0,0],[0,1],[s,1],[1,l],[1,0]]);break;case 8:r=n.interpolate(g,u,f),s=n.interpolate(u,d,f),n.polygons_full&&(a.edges.left={path:[[0,r],[s,1]],move:{x:0,y:1,enter:"bottom"}}),n.polygons&&a.polygons.push([[0,0],[0,r],[s,1],[1,1],[1,0]]);break;case 12:r=n.interpolate(g,u,f),l=n.interpolate(c,d,f),n.polygons_full&&(a.edges.left={path:[[0,r],[1,l]],move:{x:1,y:0,enter:"left"}}),n.polygons&&a.polygons.push([[0,0],[0,r],[1,l],[1,0]]);break;case 9:i=n.interpolate(g,c,f),s=n.interpolate(u,d,f),n.polygons_full&&(a.edges.bottom={path:[[i,0],[s,1]],move:{x:0,y:1,enter:"bottom"}}),n.polygons&&a.polygons.push([[i,0],[s,1],[1,1],[1,0]]);break;case 3:r=n.interpolate(g,u,f),l=n.interpolate(c,d,f),n.polygons_full&&(a.edges.right={path:[[1,l],[0,r]],move:{x:-1,y:0,enter:"right"}}),n.polygons&&a.polygons.push([[0,r],[0,1],[1,1],[1,l]]);break;case 6:i=n.interpolate(g,c,f),s=n.interpolate(u,d,f),n.polygons_full&&(a.edges.top={path:[[s,1],[i,0]],move:{x:0,y:-1,enter:"top"}}),n.polygons&&a.polygons.push([[0,0],[0,1],[s,1],[i,0]]);break;case 10:r=n.interpolate(g,u,f),l=n.interpolate(c,d,f),i=n.interpolate(g,c,f),s=n.interpolate(u,d,f),h=(g+c+d+u)/4,n.polygons_full&&(h<f?(a.edges.left={path:[[0,r],[s,1]],move:{x:0,y:1,enter:"bottom"}},a.edges.right={path:[[1,l],[i,0]],move:{x:0,y:-1,enter:"top"}}):(a.edges.right={path:[[1,l],[s,1]],move:{x:0,y:1,enter:"bottom"}},a.edges.left={path:[[0,r],[i,0]],move:{x:0,y:-1,enter:"top"}})),n.polygons&&(h<f?a.polygons.push([[0,0],[0,r],[s,1],[1,1],[1,l],[i,0]]):(a.polygons.push([[0,0],[0,r],[i,0]]),a.polygons.push([[s,1],[1,1],[1,l]])));break;case 5:r=n.interpolate(g,u,f),l=n.interpolate(c,d,f),i=n.interpolate(g,c,f),s=n.interpolate(u,d,f),h=(g+c+d+u)/4,n.polygons_full&&(h<f?(a.edges.bottom={path:[[i,0],[0,r]],move:{x:-1,y:0,enter:"right"}},a.edges.top={path:[[s,1],[1,l]],move:{x:1,y:0,enter:"left"}}):(a.edges.top={path:[[s,1],[0,r]],move:{x:-1,y:0,enter:"right"}},a.edges.bottom={path:[[i,0],[1,l]],move:{x:1,y:0,enter:"left"}})),n.polygons&&(h<f?a.polygons.push([[0,r],[0,1],[s,1],[1,l],[1,0],[i,0]]):(a.polygons.push([[0,r],[0,1],[s,1]]),a.polygons.push([[i,0],[1,l],[1,0]])))}return a}}a.prototype.cellsInBand=function(e,o,t){var n=[];return t=void 0===t||t,this.lowerBound>o||this.upperBound<e||(this.childA||this.childB||this.childC||this.childD?(this.childA&&(n=n.concat(this.childA.cellsInBand(e,o,t))),this.childB&&(n=n.concat(this.childB.cellsInBand(e,o,t))),this.childD&&(n=n.concat(this.childD.cellsInBand(e,o,t))),this.childC&&(n=n.concat(this.childC.cellsInBand(e,o,t)))):(t||this.lowerBound<=e||this.upperBound>=o)&&n.push({x:this.x,y:this.y})),n},a.prototype.cellsBelowThreshold=function(e,o){var t=[];return o=void 0===o||o,this.lowerBound>e||(this.childA||this.childB||this.childC||this.childD?(this.childA&&(t=t.concat(this.childA.cellsBelowThreshold(e,o))),this.childB&&(t=t.concat(this.childB.cellsBelowThreshold(e,o))),this.childD&&(t=t.concat(this.childD.cellsBelowThreshold(e,o))),this.childC&&(t=t.concat(this.childC.cellsBelowThreshold(e,o)))):(o||this.upperBound>=e)&&t.push({x:this.x,y:this.y})),t},e.isoLines=o,e.isoContours=o,Object.defineProperty(e,"__esModule",{value:!0})});
